<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Teams Security Monitor</title>
    <link href="styles.css" rel="stylesheet" />
  </head>
  <body>
    <div class="header">
      <h1>Nilanjan Mitra's Intern Task</h1>
      <div class="connection-indicator">
        <span id="connection-status" class="status disconnected"
          >Websocket Connecting...</span
        >
      </div>
    </div>

    <div class="container">
      <div class="button-group">
        <button class="refresh-btn" onclick="loadData()">
          üîÑ Refresh Data
        </button>
        <button class="clear-btn" onclick="clearAllDetections()">
          üóëÔ∏è Clear All
        </button>
      </div>

      <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <div class="stat-number" id="totalDetections">-</div>
          <div class="stat-label">Total Detections</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="criticalCount">-</div>
          <div class="stat-label">Critical Alerts</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="highCount">-</div>
          <div class="stat-label">High Priority</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="channelCount">-</div>
          <div class="stat-label">Affected Channels</div>
        </div>
      </div>

      <div class="detections-table">
        <div class="table-header">Active Security Detections</div>
        <div id="detectionsContainer">
          <div class="loading">Loading detections...</div>
        </div>
      </div>

      <div class="detections-table acknowledged-section">
        <div class="table-header">Acknowledged Detections</div>
        <div id="acknowledgedContainer">
          <div class="no-data">No acknowledged detections</div>
        </div>
      </div>
    </div>

    <script>
      async function loadData() {
        try {
          const [
            statsResponse,
            activeDetectionsResponse,
            acknowledgedDetectionsResponse,
          ] = await Promise.all([
            fetch("/api/stats"),
            fetch("/api/detections/status/new?limit=20"),
            fetch("/api/detections/status/acknowledged?limit=20"),
          ]);

          const stats = await statsResponse.json();
          const activeDetections = await activeDetectionsResponse.json();
          const acknowledgedDetections =
            await acknowledgedDetectionsResponse.json();

          updateStats(stats.data);
          updateDetections(activeDetections.data || []);
          updateAcknowledgedDetections(acknowledgedDetections.data || []);
        } catch (error) {
          console.error("Error loading data:", error);
          document.getElementById("detectionsContainer").innerHTML =
            '<div class="no-data">Error loading data. Please try again.</div>';
        }
      }

      function updateStats(stats) {
        document.getElementById("totalDetections").textContent =
          stats?.totalDetections || 0;
        document.getElementById("criticalCount").textContent =
          stats?.detectionsBySeverity?.CRITICAL || 0;
        document.getElementById("highCount").textContent =
          stats?.detectionsBySeverity?.HIGH || 0;
        document.getElementById("channelCount").textContent = Object.keys(
          stats?.channelStats || {}
        ).length;
      }

      function updateDetections(detections) {
        const container = document.getElementById("detectionsContainer");

        if (!detections || detections.length === 0) {
          container.innerHTML =
            '<div class="no-data">No active detections found. System is monitoring...</div>';
          return;
        }

        container.innerHTML = detections
          .map(
            (detection) => `
                <div class="detection-item">
                    <div class="detection-header">
                        <div class="detection-type">${
                          detection.secretType
                        }</div>
                        <div class="detection-actions">
                            <span class="detection-confidence">${Math.round(
                              detection.confidence * 100
                            )}% confidence</span>
                            <button class="acknowledge-btn" onclick="acknowledgeDetection('${
                              detection.id
                            }')">
                                ‚úì Acknowledge
                            </button>
                        </div>
                    </div>
                    <div class="detection-meta">
                        <span class="severity-badge severity-${detection.severity.toLowerCase()}">
                            ${detection.severity}
                        </span>
                        Channel: ${detection.channelId} | User: ${
              detection.userName
            } | 
                        ${new Date(detection.detectedAt).toLocaleString()}
                    </div>
                    <div class="masked-value">${detection.maskedValue}</div>
                </div>
            `
          )
          .join("");
      }

      function updateAcknowledgedDetections(detections) {
        const container = document.getElementById("acknowledgedContainer");

        if (!detections || detections.length === 0) {
          container.innerHTML =
            '<div class="no-data">No acknowledged detections</div>';
          return;
        }

        container.innerHTML = detections
          .map(
            (detection) => `
                <div class="detection-item acknowledged">
                    <div class="detection-header">
                        <div class="detection-type">${
                          detection.secretType
                        }</div>
                        <div class="detection-actions">
                            <span class="detection-confidence">${Math.round(
                              detection.confidence * 100
                            )}% confidence</span>
                            <div class="acknowledged-badge">
                                ‚úì Acknowledged
                            </div>
                        </div>
                    </div>
                    <div class="detection-meta">
                        <span class="severity-badge severity-${detection.severity.toLowerCase()}">
                            ${detection.severity}
                        </span>
                        Channel: ${detection.channelId} | User: ${
              detection.userName
            } | 
                        ${new Date(detection.detectedAt).toLocaleString()}
                    </div>
                    <div class="masked-value">${detection.maskedValue}</div>
                </div>
            `
          )
          .join("");
      }

      async function acknowledgeDetection(detectionId) {
        try {
          const response = await fetch(
            `/api/detections/${detectionId}/status`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ status: "acknowledged" }),
            }
          );

          if (response.ok) {
            loadData();
          } else {
            console.error("Failed to acknowledge detection");
            alert("Failed to acknowledge detection. Please try again.");
          }
        } catch (error) {
          console.error("Error acknowledging detection:", error);
          alert("Error acknowledging detection. Please try again.");
        }
      }

      async function clearAllDetections() {
        if (
          !confirm(
            "Are you sure you want to clear all detections? This action cannot be undone."
          )
        ) {
          return;
        }

        try {
          const response = await fetch("/api/detections/clear", {
            method: "DELETE",
          });

          if (response.ok) {
            loadData();
            alert("All detections cleared successfully.");
          } else {
            console.error("Failed to clear detections");
            alert("Failed to clear detections. Please try again.");
          }
        } catch (error) {
          console.error("Error clearing detections:", error);
          alert("Error clearing detections. Please try again.");
        }
      }

      // WebSocket connection for real-time updates
      let ws;

      function connectWebSocket() {
        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const wsUrl = `${protocol}//${window.location.host}/ws`;

        ws = new WebSocket(wsUrl);

        ws.onopen = function () {
          console.log("WebSocket connected");
          document.getElementById("connection-status").textContent =
            "Websocket Connected";
          document.getElementById("connection-status").className =
            "status connected";
        };

        ws.onmessage = function (event) {
          try {
            const detection = JSON.parse(event.data);
            console.log("New detection received via WebSocket:", detection);

            // Add detection to table dynamically
            addDetectionToTable(detection);

            // Update stats counters
            updateStatsCounters();
          } catch (error) {
            console.error("Error parsing WebSocket message:", error);
          }
        };

        ws.onclose = function () {
          console.log("WebSocket disconnected");
          document.getElementById("connection-status").textContent =
            "Websocket Disconnected";
          document.getElementById("connection-status").className =
            "status disconnected";

          // Attempt to reconnect after 3 seconds
          setTimeout(connectWebSocket, 3000);
        };

        ws.onerror = function (error) {
          console.error("WebSocket error:", error);
        };
      }

      // Add detection to table dynamically
      function addDetectionToTable(detection) {
        const detectionsContainer = document.getElementById(
          "detectionsContainer"
        );
        if (!detectionsContainer) return;

        const loadingEl =
          detectionsContainer.querySelector(".loading, .no-data");
        if (loadingEl) {
          loadingEl.remove();
        }

        // Create detection item element
        const detectionItem = document.createElement("div");
        detectionItem.className = "detection-item";
        detectionItem.id = `detection-${detection.id}`;

        const severityClass = detection.severity.toLowerCase();
        const confidencePercent = Math.round(detection.confidence * 100);
        const detectedTime = new Date(detection.detectedAt).toLocaleString();

        detectionItem.innerHTML = `
            <div class="detection-header">
                <div class="detection-type">${detection.secretType}</div>
                <div class="detection-actions">
                    <span class="detection-confidence">${confidencePercent}% confidence</span>
                    <button class="acknowledge-btn" onclick="acknowledgeDetection('${
                      detection.id
                    }')">
                        ‚úì Acknowledge
                    </button>
                </div>
            </div>
            <div class="detection-meta">
                <span class="severity-badge severity-${severityClass}">
                    ${detection.severity}
                </span>
                Channel: ${
                  detection.channelId || detection.channelID
                } | User: ${detection.userName} | 
                ${detectedTime}
            </div>
            <div class="masked-value">${detection.maskedValue}</div>
        `;

        detectionItem.style.opacity = "0";
        detectionItem.style.transform = "translateY(-20px)";

        detectionsContainer.insertBefore(
          detectionItem,
          detectionsContainer.firstChild
        );

        // Animate in
        setTimeout(() => {
          detectionItem.style.transition = "all 0.3s ease-out";
          detectionItem.style.opacity = "1";
          detectionItem.style.transform = "translateY(0)";
        }, 50);
      }

      function updateStatsCounters() {
        // Get current detections from DOM
        const detectionItems = document.querySelectorAll(
          ".detection-item:not(.acknowledged)"
        );
        let totalCount = detectionItems.length;
        let criticalCount = 0;
        let highCount = 0;

        detectionItems.forEach((item) => {
          const severityBadge = item.querySelector(".severity-badge");
          if (severityBadge) {
            const severity = severityBadge.textContent.trim();
            if (severity === "CRITICAL") criticalCount++;
            else if (severity === "HIGH") highCount++;
          }
        });

        document.getElementById("totalDetections").textContent = totalCount;
        document.getElementById("criticalCount").textContent = criticalCount;
        document.getElementById("highCount").textContent = highCount;

        // Update channel count (simplified - just count unique channels from visible detections)
        const channels = new Set();
        detectionItems.forEach((item) => {
          const metaText =
            item.querySelector(".detection-meta")?.textContent || "";
          const channelMatch = metaText.match(/Channel: ([^|]+)/);
          if (channelMatch) {
            channels.add(channelMatch[1].trim());
          }
        });
        document.getElementById("channelCount").textContent = channels.size;
      }

      loadData();
      connectWebSocket();
    </script>
  </body>
</html>
